#!/bin/zsh

# git-upload
#
# Usage:
#   git-upload [--aiDiffCommitMsg|-ai] [commit message]
#
# Behaviour:
#   - If --aiDiffCommitMsg / -ai is passed, the script will generate a commit
#     message from the current diff using an external AI helper command.
#   - Otherwise, it uses the first non-flag argument as the commit message,
#     defaulting to "default commit message".
#
# AI integration:
#   To avoid hard-coding a specific tool, this script expects an environment
#   variable GIT_UPLOAD_AI_CMD to point to a command that:
#     - reads the diff from stdin
#     - prints a single-line commit message to stdout
#
#   When the -ai/--aiDiffCommitMsg flag is used, you'll be prompted:
#     "AI prompt (leave blank for default): "
#   If you press Enter, the script uses this default prompt:
#     "examine differences between the last known push to this repository and the current state, write a clean concise one-three line message for this diff"
#
#   The chosen prompt is exposed to the AI command via the
#   GIT_UPLOAD_AI_PROMPT environment variable. For example, with GitHub
#   Copilot CLI installed via Homebrew (binary name: `copilot`):
#     export GIT_UPLOAD_AI_CMD='copilot -s --allow-all-tools --allow-all-paths -p "$GIT_UPLOAD_AI_PROMPT"'
#
#   You can instead point GIT_UPLOAD_AI_CMD at any other AI CLI that accepts
#   a prompt (via $GIT_UPLOAD_AI_PROMPT) and optionally reads a diff on stdin.

set -euo pipefail

use_ai=false
user_msg=""
ai_prompt=""

for arg in "$@"; do
	case "$arg" in
		--aiDiffCommitMsg|-ai)
			use_ai=true
			;;
		--*)
			# Ignore other flags for now
			;;
		*)
			if [ -z "$user_msg" ]; then
				user_msg="$arg"
			fi
			;;
	esac
done

generate_ai_message() {
	if [ -z "${GIT_UPLOAD_AI_CMD-}" ]; then
		echo "[git-upload] GIT_UPLOAD_AI_CMD is not set; falling back to manual message" >&2
		return 1
	fi

	if ! command -v ${GIT_UPLOAD_AI_CMD%% *} >/dev/null 2>&1; then
		echo "[git-upload] AI command not found: ${GIT_UPLOAD_AI_CMD%% *}" >&2
		return 1
	fi

	local default_prompt="examine differences between the last known push to this repository and the current state, write a clean concise one-three line message for this diff"
	local effective_prompt

	if [ -n "${ai_prompt-}" ]; then
		effective_prompt="$ai_prompt"
	else
		effective_prompt="$default_prompt"
	fi

	# Use staged changes for the diff so we don't accidentally commit
	# un-staged files. If nothing is staged, use the working-tree diff.
	if git diff --cached --quiet 2>/dev/null; then
		diff_source="working tree"
		diff_cmd="git diff"
	else
		diff_source="staged changes"
		diff_cmd="git diff --cached"
	fi

	echo "[git-upload] Generating AI commit message from $diff_sourceâ€¦" >&2

	# shellcheck disable=SC2086
	eval "$diff_cmd" | GIT_UPLOAD_AI_PROMPT="$effective_prompt" eval "$GIT_UPLOAD_AI_CMD" | head -n 1 | tr '\n' ' '
}

main() {
	if [ "$use_ai" = true ]; then
		printf "AI prompt (leave blank for default): " >&2
		IFS= read -r ai_prompt || ai_prompt=""
	fi

	git add .

	commit_msg="${user_msg:-default commit message}"

	if [ "$use_ai" = true ]; then
		if ai_msg=$(generate_ai_message); then
			# Prefer AI message; fall back to user_msg if AI returns empty
			if [ -n "${ai_msg// /}" ]; then
				commit_msg="$ai_msg"
			fi
		fi
	fi

	echo "[git-upload] Using commit message: $commit_msg" >&2

	git commit -m "$commit_msg"
	git push -u origin main
}

main "$@"